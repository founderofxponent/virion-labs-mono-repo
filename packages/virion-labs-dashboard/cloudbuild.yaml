steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--build-arg'
      - 'NODE_ENV=production'
      - '--build-arg'
      - 'NEXT_TELEMETRY_DISABLED=1'
      - '--build-arg'
      - 'NEXT_PUBLIC_API_URL=https://api.virionlabs.io'
      - '--build-arg'
      - 'NEXT_PUBLIC_BUSINESS_LOGIC_API_URL=https://api.virionlabs.io'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/cloud-run-source-deploy/${_SERVICE_NAME}:latest'
      - '.'

  # Push the container image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/cloud-run-source-deploy/${_SERVICE_NAME}:latest'

  # Deploy container image to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/cloud-run-source-deploy/${_SERVICE_NAME}:latest'
      - '--region=${_REGION}'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--port=3000'
      - '--cpu=2'
      - '--memory=2Gi'
      - '--min-instances=1'
      - '--max-instances=10'
      - '--timeout=3600'
      - '--concurrency=1000'
      - '--set-env-vars=NODE_ENV=production,NEXT_TELEMETRY_DISABLED=1,NEXT_PUBLIC_API_URL=https://api.virionlabs.io,NEXT_PUBLIC_API_KEY=${_API_KEY},NEXT_PUBLIC_SUPABASE_URL=${_SUPABASE_URL},NEXT_PUBLIC_SUPABASE_ANON_KEY=${_SUPABASE_ANON_KEY},SUPABASE_SERVICE_ROLE_KEY=${_SUPABASE_SERVICE_ROLE_KEY},SUPABASE_PROJECT_ID=${_SUPABASE_PROJECT_ID},SUPABASE_ENV=production,DISCORD_BOT_TOKEN=${_DISCORD_BOT_TOKEN},DISCORD_GUILD_ID=${_DISCORD_GUILD_ID},DISCORD_JOIN_CAMPAIGNS_CHANNEL_ID=${_DISCORD_JOIN_CAMPAIGNS_CHANNEL_ID},NEXT_PUBLIC_APP_URL=https://app.virionlabs.io,NEXTAUTH_URL=https://app.virionlabs.io,NEXTAUTH_SECRET=${_NEXTAUTH_SECRET},DEBUG_MODE=false,VERBOSE_LOGGING=false,NEXT_PUBLIC_BUSINESS_LOGIC_API_URL=https://api.virionlabs.io'
      - '--execution-environment=gen2'

# Default substitutions
substitutions:
  _REGION: us-central1
  _SERVICE_NAME: virion-labs-dashboard

images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/cloud-run-source-deploy/${_SERVICE_NAME}:latest'

options:
  logging: CLOUD_LOGGING_ONLY